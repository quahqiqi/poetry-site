<!-- floatbar.html - 悬浮搜索栏 -->
<style>
  /* scope: #fb-outer 避免全局污染 */
  #fb-outer{ position:fixed; right:20px; bottom:24px; z-index:99999; font-family: inherit; }
  #fb-outer *{ box-sizing:border-box; }

  #fb-bar {
    width:320px; max-width:calc(100vw - 40px);
    background: rgba(253,246,227,0.98);
    border-radius:14px;
    box-shadow: 0 8px 28px rgba(10,10,10,0.12);
    overflow:hidden;
    transform-origin: bottom right;
    display:flex; flex-direction:column;
    backdrop-filter: blur(6px);
    transition: transform .22s cubic-bezier(.2,.9,.2,1), opacity .18s;
  }

  #fb-bar .fb-head{ display:flex; align-items:center; gap:10px; padding:10px 12px; }
  #fb-bar .fb-logo{ width:36px; height:36px; flex:0 0 36px; display:grid; place-items:center; border-radius:9px; }
  #fb-bar .fb-title{ font-weight:600; font-size:14px; color:#3a2e2a; }
  #fb-bar .fb-actions{ margin-left:auto; display:flex; gap:8px; align-items:center; }

  #fb-bar .fb-search{ display:flex; gap:8px; padding:10px 12px 14px; border-top:1px solid rgba(0,0,0,0.04); }
  #fb-bar input[type="search"]{ flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(0,0,0,0.06); font-size:14px; background:transparent; outline:none; color:inherit; }
  #fb-bar input::placeholder{ color:#9b8c80; font-style:italic; }
  #fb-bar .fb-submit{ padding:10px 12px; border-radius:10px; border:0; cursor:pointer; background:#b89c7a; color:#fff; font-weight:700; }

  #fb-closed {
    width:56px; height:56px; border-radius:50%; background:rgba(253,246,227,0.98);
    box-shadow:0 8px 28px rgba(10,10,10,0.12); display:grid; place-items:center; cursor:pointer;
  }

  #fb-bar[hidden]{ display:none; }
  #fb-closed[hidden]{ display:none; }

  @media (max-width:420px){
    #fb-bar{ width: min(94vw, 360px); border-radius:12px; }
  }
</style>

<div id="fb-outer" aria-live="polite">
  <!-- 初始按钮：放大镜 -->
  <div id="fb-closed" title="打开工具" role="button" aria-label="打开浮动工具">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" 
         viewBox="0 0 24 24" fill="none" stroke="currentColor" 
         stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="11" cy="11" r="8"></circle>
      <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
    </svg>
  </div>

  <!-- 展开后的搜索栏 -->
  <div id="fb-bar" role="region" aria-label="悬浮工具" hidden>
    <div class="fb-head">
      <div class="fb-logo" aria-hidden="true">
        <svg width="36" height="36" viewBox="0 0 48 48" fill="none" aria-hidden="true">
          <rect x="0" y="0" width="48" height="48" rx="10" fill="#fff"/>
          <path d="M12 32c6-8 24-8 28-12" stroke="#b89c7a" stroke-width="2.8" stroke-linecap="round"/>
          <circle cx="14" cy="16" r="3.2" fill="#b89c7a"/>
        </svg>
      </div>
      <div class="fb-title">网站工具 · 快速搜索</div>
      <div class="fb-actions">
        <button id="fb-min" title="收起" aria-label="收起浮动栏" style="background:transparent;border:0;padding:6px;border-radius:8px;cursor:pointer">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M6 6L18 18M6 18L18 6" stroke="#6b5749" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
    </div>

    <form id="fb-search-form" class="fb-search" role="search" aria-label="站内搜索">
      <input id="fb-search-input" name="q" type="search" placeholder="在诗集、目录、页面中搜索（回车）" aria-label="搜索输入框" autocomplete="off" />
      <button type="submit" class="fb-submit" aria-label="搜索">搜 索</button>
    </form>
  </div>
</div>

<script>
(function(){
  const closed = document.getElementById('fb-closed');
  const bar = document.getElementById('fb-bar');
  const minBtn = document.getElementById('fb-min');
  const form = document.getElementById('fb-search-form');
  const input = document.getElementById('fb-search-input');

  // 打开
  closed.addEventListener('click', openBar);
  function openBar(){
    closed.setAttribute('hidden','');
    bar.removeAttribute('hidden');
    bar.style.transform = 'translateY(6px) scale(.98)';
    bar.style.opacity = '0';
    requestAnimationFrame(()=>{
      bar.style.transform = 'translateY(0) scale(1)';
      bar.style.opacity = '1';
    });
    setTimeout(()=> input.focus(), 260);
  }

  // 收起
  minBtn.addEventListener('click', closeBar);
  function closeBar(){
    bar.style.transform = 'translateY(6px) scale(.98)';
    bar.style.opacity = '0';
    setTimeout(()=>{
      bar.setAttribute('hidden','');
      closed.removeAttribute('hidden');
    }, 220);
  }

  // Esc 收起 / Ctrl+K 打开
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape'){
      if(!bar.hasAttribute('hidden')) closeBar();
    }
    if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k'){
      e.preventDefault();
      if(bar.hasAttribute('hidden')) openBar();
      else closeBar();
    }
  });

  // 载入 poems.json
  let poemsIndex = [];
  fetch("assets/data/poems.json")
    .then(res => res.json())
    .then(data => { poemsIndex = data; })
    .catch(err => console.error("无法加载 poems.json", err));

  // 搜索逻辑
  form.addEventListener('submit', function(e){
    e.preventDefault();
    const q = (input.value || '').trim();
    if(!q){ input.focus(); return; }

    const matches = poemsIndex.filter(p => p.title.includes(q));

    if(matches.length === 1){
      window.location.href = matches[0].file;
    } else if(matches.length > 1){
      alert("找到多个结果：\n" + matches.map(p=>p.title).join("、"));
    } else {
      alert("未找到匹配结果：《" + q + "》");
    }
  });
})();
</script>
